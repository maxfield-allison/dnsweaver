# dnsweaver - GitLab CI/CD Pipeline
# Streamlined from go-project-template

stages: [validate, test, security, build, docker, mirror, deploy, github-release]

variables:
  GOPROXY: https://proxy.golang.org,direct
  GOFLAGS: "-mod=readonly"
  BINARY_NAME: "dnsweaver"
  REGISTRY: "registry.bluewillows.net"
  IMAGE: "registry.bluewillows.net/root/dnsweaver"
  # Deploy target - set these as CI/CD variables or override here
  # DEPLOY_HOST: "swarm-manager.example.com"
  # DEPLOY_USER: "deploy"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH =~ /^(main|develop)$/ || $CI_COMMIT_BRANCH =~ /^(feature|bugfix|hotfix)\//
    - if: $CI_COMMIT_TAG

# Rule templates
.rules-code-changes: &rules-code-changes
  - if: $CI_COMMIT_TAG
  - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
    changes: &code-files ["{**/*.go,go.mod,go.sum}"]
  - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    changes: *code-files

.rules-docker: &rules-docker
  - if: $CI_COMMIT_TAG
  - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"
    changes: &docker-files ["{**/*.go,go.mod,go.sum,Dockerfile,.dockerignore}"]

.go-base:
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache git
    - go mod download

# ─────────────────────────────────────────────────────────────────────────────
# Validate
# ─────────────────────────────────────────────────────────────────────────────

validate:branch-name:
  stage: validate
  image: alpine:3.20
  script:
    - |
      [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_COMMIT_BRANCH" = "develop" ] && exit 0
      [ -n "$CI_COMMIT_TAG" ] && exit 0
      echo "$CI_COMMIT_REF_NAME" | grep -qE "^(feature|bugfix|hotfix)/[0-9]+-" && echo "✅ $CI_COMMIT_REF_NAME" || echo "⚠️ Non-standard: $CI_COMMIT_REF_NAME"
  rules:
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
  allow_failure: true

validate:commit-message:
  stage: validate
  image: alpine:3.20
  script:
    - |
      MSG=$(echo "$CI_COMMIT_MESSAGE" | head -1)
      echo "$MSG" | grep -qE "^Merge " && exit 0
      echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?: " && echo "✅ $MSG" || echo "⚠️ $MSG"
  rules:
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
  allow_failure: true

# ─────────────────────────────────────────────────────────────────────────────
# Test & Security
# ─────────────────────────────────────────────────────────────────────────────

lint:
  extends: .go-base
  stage: test
  script:
    - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
    - golangci-lint run --timeout 5m
  rules: *rules-code-changes
  allow_failure: true

test:go:
  extends: .go-base
  stage: test
  script:
    - go test -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report: { coverage_format: cobertura, path: coverage.out }
  rules: *rules-code-changes

security:trivy:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy fs --exit-code 0 --severity HIGH,CRITICAL --format table .
  rules: *rules-code-changes
  allow_failure: true

security:govulncheck:
  extends: .go-base
  stage: security
  script:
    - go install golang.org/x/vuln/cmd/govulncheck@latest
    - govulncheck ./... || true
  rules: *rules-code-changes
  allow_failure: true

# ─────────────────────────────────────────────────────────────────────────────
# Build
# ─────────────────────────────────────────────────────────────────────────────

build:go:
  extends: .go-base
  stage: build
  script:
    - apk add --no-cache ca-certificates tzdata
    - CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o $BINARY_NAME ./cmd/dnsweaver
  artifacts:
    paths: [$BINARY_NAME]
    expire_in: 1 day
  rules: *rules-code-changes

# ─────────────────────────────────────────────────────────────────────────────
# Docker (multi-arch)
# ─────────────────────────────────────────────────────────────────────────────

.docker-base:
  stage: docker
  image: docker:cli
  variables:
    DOCKER_HOST: unix:///var/run/docker.sock
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $REGISTRY
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then TAG="$CI_COMMIT_TAG"; EXTRA="latest"
      elif [ "$CI_COMMIT_BRANCH" = "main" ]; then TAG="edge"; EXTRA=""
      elif [ "$CI_COMMIT_BRANCH" = "develop" ]; then TAG="dev"; EXTRA=""
      else TAG="$CI_COMMIT_SHORT_SHA"; EXTRA=""; fi
      echo "TAG=$TAG" > build.env && echo "EXTRA=$EXTRA" >> build.env
  rules: *rules-docker

docker:build:amd64:
  extends: .docker-base
  script:
    - source build.env
    - docker build --platform linux/amd64 --build-arg VERSION=$CI_COMMIT_SHORT_SHA -t $IMAGE:$TAG-amd64 -t $IMAGE:sha-$CI_COMMIT_SHORT_SHA-amd64 .
    - docker push $IMAGE:$TAG-amd64 && docker push $IMAGE:sha-$CI_COMMIT_SHORT_SHA-amd64
  artifacts:
    reports: { dotenv: build.env }
  tags: [docker]

docker:build:arm64:
  extends: .docker-base
  script:
    - source build.env
    - docker build --platform linux/arm64 --build-arg VERSION=$CI_COMMIT_SHORT_SHA -t $IMAGE:$TAG-arm64 -t $IMAGE:sha-$CI_COMMIT_SHORT_SHA-arm64 .
    - docker push $IMAGE:$TAG-arm64 && docker push $IMAGE:sha-$CI_COMMIT_SHORT_SHA-arm64
  tags: [arm64]

docker:manifest:
  extends: .docker-base
  needs: [docker:build:amd64, docker:build:arm64]
  script:
    - source build.env
    - docker buildx create --name mb --use 2>/dev/null || docker buildx use mb
    - docker buildx imagetools create -t $IMAGE:$TAG $IMAGE:$TAG-amd64 $IMAGE:$TAG-arm64
    - docker buildx imagetools create -t $IMAGE:sha-$CI_COMMIT_SHORT_SHA $IMAGE:sha-$CI_COMMIT_SHORT_SHA-amd64 $IMAGE:sha-$CI_COMMIT_SHORT_SHA-arm64
    - '[ -n "$EXTRA" ] && docker buildx imagetools create -t $IMAGE:$EXTRA $IMAGE:$TAG-amd64 $IMAGE:$TAG-arm64 || true'
  tags: [docker]

# ─────────────────────────────────────────────────────────────────────────────
# GitHub Mirror (native push - preserves PR history)
# ─────────────────────────────────────────────────────────────────────────────

.mirror-base:
  stage: mirror
  image: alpine:3.20
  needs:
    - job: docker:manifest
      optional: true
  before_script:
    - apk add --no-cache git
    - git config --global user.email "ci@gitlab.local"
    - git config --global user.name "GitLab CI"

github:mirror:
  extends: .mirror-base
  variables:
    GIT_DEPTH: 0  # Full clone for complete history
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "develop" ]; then
        GITHUB_BRANCH="dev"
      else
        GITHUB_BRANCH="$CI_COMMIT_BRANCH"
      fi
      git remote add github "https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/$GITHUB_REPO.git" || true
      git fetch origin $CI_COMMIT_BRANCH --unshallow 2>/dev/null || git fetch origin $CI_COMMIT_BRANCH
      git checkout -B $CI_COMMIT_BRANCH origin/$CI_COMMIT_BRANCH
      git push github $CI_COMMIT_BRANCH:$GITHUB_BRANCH --force
      echo "✅ Mirrored $CI_COMMIT_BRANCH → github:$GITHUB_BRANCH"
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"

github:mirror:tags:
  extends: .mirror-base
  variables:
    GIT_DEPTH: 0  # Full clone for complete history
  script:
    - |
      git remote add github "https://$GITHUB_USERNAME:$GITHUB_TOKEN@github.com/$GITHUB_REPO.git" || true
      git fetch origin --tags --unshallow 2>/dev/null || git fetch origin --tags
      git push github $CI_COMMIT_TAG
      echo "✅ Pushed tag $CI_COMMIT_TAG to GitHub"
  rules:
    - if: $CI_COMMIT_TAG

# ─────────────────────────────────────────────────────────────────────────────
# Deploy
# ─────────────────────────────────────────────────────────────────────────────

.deploy-base:
  stage: deploy
  image: alpine:3.20
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519 || true
    - '[ -n "$DEPLOY_HOST" ] && ssh-keyscan -p 22 $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true'

deploy:dev:
  extends: .deploy-base
  environment: { name: development }
  script:
    - |
      [ -z "$SSH_PRIVATE_KEY" ] && echo "SSH_PRIVATE_KEY not set" && exit 0
      [ -z "$DEPLOY_HOST" ] && echo "DEPLOY_HOST not set" && exit 0
      ssh -o StrictHostKeyChecking=no ${DEPLOY_USER:-deploy}@$DEPLOY_HOST \
        "docker service update --force --image $IMAGE:dev dnsweaver_dnsweaver" || echo "Service not deployed"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      changes: *docker-files
      when: manual
  allow_failure: true

deploy:production:
  extends: .deploy-base
  environment: { name: production }
  script:
    - |
      [ -z "$SSH_PRIVATE_KEY" ] && echo "SSH_PRIVATE_KEY not set" && exit 0
      [ -z "$DEPLOY_HOST" ] && echo "DEPLOY_HOST not set" && exit 0
      [ -n "$CI_COMMIT_TAG" ] && IMG="$IMAGE:$CI_COMMIT_TAG" || IMG="$IMAGE:edge"
      ssh -o StrictHostKeyChecking=no ${DEPLOY_USER:-deploy}@$DEPLOY_HOST \
        "docker service update --force --image $IMG dnsweaver_dnsweaver" || echo "Service not deployed"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes: *docker-files
      when: manual
    - if: $CI_COMMIT_TAG
      when: manual
  allow_failure: true

# ─────────────────────────────────────────────────────────────────────────────
# GitHub Release (tags only)
# ─────────────────────────────────────────────────────────────────────────────

.github-docker:
  stage: github-release
  image: docker:cli
  before_script:
    - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
    - echo "$DOCKERHUB_TOKEN" | docker login docker.io -u "$DOCKERHUB_USERNAME" --password-stdin
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/

github:build:amd64:
  extends: .github-docker
  script:
    - |
      GHCR="ghcr.io/$GITHUB_REPO"
      DH="docker.io/$DOCKERHUB_USERNAME/dnsweaver"
      docker build --platform linux/amd64 --build-arg VERSION=$CI_COMMIT_TAG \
        --label org.opencontainers.image.source=https://github.com/$GITHUB_REPO \
        -t $GHCR:$CI_COMMIT_TAG-amd64 -t $DH:$CI_COMMIT_TAG-amd64 .
      docker push $GHCR:$CI_COMMIT_TAG-amd64 && docker push $DH:$CI_COMMIT_TAG-amd64
  tags: [docker]

github:build:arm64:
  extends: .github-docker
  script:
    - |
      GHCR="ghcr.io/$GITHUB_REPO"
      DH="docker.io/$DOCKERHUB_USERNAME/dnsweaver"
      docker build --platform linux/arm64 --build-arg VERSION=$CI_COMMIT_TAG \
        --label org.opencontainers.image.source=https://github.com/$GITHUB_REPO \
        -t $GHCR:$CI_COMMIT_TAG-arm64 -t $DH:$CI_COMMIT_TAG-arm64 .
      docker push $GHCR:$CI_COMMIT_TAG-arm64 && docker push $DH:$CI_COMMIT_TAG-arm64
  tags: [arm64]

github:release:
  stage: github-release
  image: alpine:3.20
  needs: [github:build:amd64, github:build:arm64, github:mirror:tags]
  before_script:
    - apk add --no-cache curl jq docker-cli
    - echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
    - echo "$DOCKERHUB_TOKEN" | docker login docker.io -u "$DOCKERHUB_USERNAME" --password-stdin
  script:
    - |
      TAG="$CI_COMMIT_TAG"
      GHCR="ghcr.io/$GITHUB_REPO"
      DH="docker.io/$DOCKERHUB_USERNAME/dnsweaver"

      # Create manifests
      for R in "$GHCR" "$DH"; do
        docker manifest create $R:$TAG $R:$TAG-amd64 $R:$TAG-arm64 && docker manifest push $R:$TAG
        docker manifest create $R:latest $R:$TAG-amd64 $R:$TAG-arm64 && docker manifest push $R:latest
      done

      # Extract changelog
      VER=$(echo "$TAG" | sed 's/^v//')
      NOTES=$(awk "BEGIN{p=0} /^## \\[$VER\\]/{p=1; next} p && /^## \\[/{p=0} p" CHANGELOG.md 2>/dev/null || echo "See CHANGELOG.md")

      # Create GitHub release
      BODY=$(printf '%s\n\n## Docker Images\n```bash\ndocker pull %s:%s\ndocker pull %s:%s\n```' "$NOTES" "$GHCR" "$TAG" "$DH" "$TAG")
      curl -sX POST "https://api.github.com/repos/$GITHUB_REPO/releases" \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$(jq -n --arg tag "$TAG" --arg name "$TAG" --arg body "$BODY" '{tag_name:$tag,name:$name,body:$body,draft:false,prerelease:false}')"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/
  tags: [docker]
