# Local development environment for dnsweaver testing
# Usage:
#   1. Copy this file: cp docker-compose.dev.example.yml docker-compose.dev.yml
#   2. Edit docker-compose.dev.yml with your DNS server details
#   3. Set TECHNITIUM_TOKEN in .env or environment
#   4. Run: docker compose -f docker-compose.dev.yml up --build

services:
  # dnsweaver service
  dnsweaver:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dnsweaver-dev
    user: root  # Required for Docker socket access in local dev
    environment:
      - DNSWEAVER_LOG_LEVEL=debug
      - DNSWEAVER_LOG_FORMAT=text
      - DNSWEAVER_DOCKER_MODE=standalone
      - DNSWEAVER_RECONCILE_INTERVAL=10s
      - DNSWEAVER_DEFAULT_TTL=60
      - DNSWEAVER_ADOPT_EXISTING=true
      - DNSWEAVER_CLEANUP_ON_STOP=false
      # Source configuration - enable dnsweaver native labels
      - DNSWEAVER_SOURCES=dnsweaver
      # Provider configuration - update these for your environment
      - DNSWEAVER_INSTANCES=test-dns
      - DNSWEAVER_TEST_DNS_TYPE=technitium
      - DNSWEAVER_TEST_DNS_URL=http://dns.example.com:5380
      - DNSWEAVER_TEST_DNS_TOKEN=${TECHNITIUM_TOKEN}
      - DNSWEAVER_TEST_DNS_ZONE=test.example.com
      - DNSWEAVER_TEST_DNS_DOMAIN_FILTER=test.example.com
      - DNSWEAVER_TEST_DNS_TARGET=10.0.0.100
      - DNSWEAVER_TEST_DNS_DOMAINS=*.test.example.com
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # Test service with DNS labels
  test-app:
    image: traefik/whoami:latest
    container_name: dnsweaver-test-app
    labels:
      # Standard A record
      - "dnsweaver.hostname=whoami.test.example.com"
      # Named records for additional testing
      - "dnsweaver.records.ipv6.hostname=whoami-v6.test.example.com"
      - "dnsweaver.records.ipv6.type=AAAA"
      - "dnsweaver.records.ipv6.target=fd00::1"
      # SRV record for testing
      - "dnsweaver.records.minecraft.hostname=_minecraft._tcp.test.example.com"
      - "dnsweaver.records.minecraft.type=SRV"
      - "dnsweaver.records.minecraft.target=mc.test.example.com"
      - "dnsweaver.records.minecraft.port=25565"
      - "dnsweaver.records.minecraft.priority=10"
      - "dnsweaver.records.minecraft.weight=100"
